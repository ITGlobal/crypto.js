!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.nsd=t():e.nsd=t()}(window,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(n(2))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){this.handlers=[],this.resolution=-1}return e.prototype.then=function(e,t,n){this.handlers.push([e,t,n]),this.resolution<0||this.handle(this.resolution)},e.prototype.resolve=function(e){this.result=e,this.handle(this.resolution=0)},e.prototype.reject=function(e){this.result=e,this.handle(this.resolution=1)},e.prototype.notify=function(e){for(var t=0;t<this.handlers.length;++t){var n=this.handlers[t][2];n&&n.call(null,e)}},e.prototype.handle=function(e){for(;this.handlers.length;){var t=this.handlers.shift()[e];t&&t.call(null,this.result)}},e}();t.Deferred=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),o=n(3),s=function(){function e(t){this.options=t,this.session=null;var n=this.settings=o.getOptions(t,e.settings),r=n.noSsl;n.port;this.baseUrl=(r?"http":"https")+"://127.0.0.1:"}return e.prototype.getVersion=function(){var e=o.send("GET",this.baseUrl,"/version",null);return this.settings.transformPromise(e)},e.prototype.getProfiles=function(){var e=o.send("GET",this.baseUrl,"/csp/profiles",null);return this.settings.transformPromise(e)},e.prototype.getTypes=function(){var e=o.send("POST",this.baseUrl,"/csp/types",null);return this.settings.transformPromise(e)},e.prototype.open=function(e){var t=this;this.session=null;var n=this.sessionPromise=o.send("POST",this.baseUrl,"/csp/open",e,function(e){return t.session={id:e.id,type:e.type,profile:e.profile}});return n.then(null,function(){t.sessionPromise=null}),this.settings.transformPromise(n)},e.prototype.close=function(){var e=this;return this.executeSession("POST","/csp/close",null,function(t){return e.sessionPromise=null,e.session=null,{id:t.id,type:t.type,profile:t.profile}})},e.prototype.pack=function(e,t){var n,s,i=this,u=new Array(e.length),c=new r.Deferred,f=(n=0,s=e.length,function(){++n===s&&i.executeSession("POST","/csp/pack",{files:u,options:t}).then(function(e){return c.resolve(e)},function(e){return c.reject(e)})}),l=function(e){l=function(){},c.reject(e)};return e.forEach(function(e,t){o.toCrutchBlob(e).then(function(n){u[t]={name:e.name,content:n.content,encoding:n.encoding},f()},l)}),this.settings.transformPromise(c)},e.prototype.unpack=function(e){var t=this,n=new r.Deferred;return o.toCrutchBlob(e).then(function(e){return t.executeSession("POST","/csp/unpack",{data:e}).then(function(e){return n.resolve(e)},function(e){return n.reject(e)})},function(e){return n.reject(e)}),this.settings.transformPromise(n)},e.prototype.getCerts=function(){return this.executeSession("POST","/csp/certs",null)},e.prototype.sign=function(e,t,n){var s,i,u=this,c=new r.Deferred;return n?(o.toCrutchBlob(n).then(function(e){return i=e}),s=!0):(i=null,s=!1),o.toCrutchBlob(e).then(function(e){return u.executeSession("POST","/csp/sign",{data:e,signature:i,options:o.getOptions(t,{pkcs7:!1,detached:s,sendCertificate:!1,sendChain:!1})}).then(function(e){return c.resolve(e)},function(e){return c.reject(e)})},function(e){return c.reject(e)}),this.settings.transformPromise(c)},e.prototype.encrypt=function(e,t){var n=this,s=new r.Deferred;return o.toCrutchBlob(e).then(function(e){return n.executeSession("POST","/csp/encrypt",{data:e,options:o.getOptions(t,{pkcs7:t.pkcs7,flags:t.flags,receivers:t.receivers})}).then(function(e){return s.resolve(e)},function(e){return s.reject(e)})},function(e){return s.reject(e)}),this.settings.transformPromise(s)},e.prototype.decrypt=function(e,t){var n=this,s=new r.Deferred;return o.toCrutchBlob(e).then(function(e){return n.executeSession("POST","/csp/decrypt",{data:e,options:o.getOptions(t,{pkcs7:t.pkcs7,flags:t.flags})}).then(function(e){return s.resolve(e)},function(e){return s.reject(e)})},function(e){return s.reject(e)}),this.settings.transformPromise(s)},e.prototype.importCertificate=function(e){var t=this,n=new r.Deferred;return o.toCrutchBlob(e).then(function(e){return t.executeSession("POST","/csp/import",{data:e}).then(function(e){return n.resolve(e)},function(e){return n.reject(e)})},function(e){return n.reject(e)}),this.settings.transformPromise(n)},e.prototype.getHeadCert=function(){return this.executeSession("POST","/csp/head",null)},e.prototype.getHeadCertFor=function(t){var n=new r.Deferred,o=new e(this.options);return o.open(t).then(function(){o.getHeadCert().then(function(e){o.close().then(function(){return n.resolve(e)},function(e){return n.reject(e)})},function(e){o.close().then(function(){return n.reject(e)},function(){return n.reject(e)})})},function(e){return n.reject(e)}),this.settings.transformPromise(n)},e.prototype.executeSession=function(e,t,n,r){var s=this;return this.whenSession(function(){return null==n?n=s.session.id:n.id=s.session.id,o.send(e,s.baseUrl,t,n,r)})},e.prototype.whenSession=function(e){var t=new r.Deferred;function n(){t.reject({code:"E_NO_SESSION",message:"There is no active session"})}return this.sessionPromise?this.sessionPromise.then(function(){e().then(function(e){return t.resolve(e)},function(e){return t.reject(e)},function(e){return t.notify(e)})},n):n(),this.settings.transformPromise(t)},e.settings={defaultPort:48737,port:{value:-1},useFileApi:!1,transformPromise:function(e){return e},noSsl:!1},e}();t.CryptoClient=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),o=n(0);function s(e,t,n,o){var s=new r.Deferred;try{var u=new i;u.onload=function(){var e=JSON.parse(u.responseText),t=e.status,n=e.content;t>0&&t<400?s.resolve(o?o(n):n):s.reject(n)},u.onerror=function(){s.reject({code:"E_CONNECTION_ERROR",message:"Cannot connect to server"})},u.open(e,t),u.send(JSON.stringify(n))}catch(e){s.reject({code:"E_CONNECTION_ERROR",message:e.message})}return s}t.toCrutchBlob=function(e){if(window.Blob&&e instanceof Blob)return function(e){var t=new r.Deferred,n=new FileReader;return n.onload=function(){var e=(this.result||"").replace(/^data:(.{0,99},)?/,"");t.resolve({content:e,encoding:"base64"})},n.onerror=function(){t.reject({code:"E_INVALID_DATA",message:"Cannot convert Blob to base64",args:{originalError:n.error}})},n.readAsDataURL(e),t}(e);var t=new r.Deferred;return t.resolve(e),t},t.send=function(e,t,n,i,u){var c=new r.Deferred;return function(e){if(-1===o.CryptoClient.settings.port.value)return s("GET",e+o.CryptoClient.settings.defaultPort+"/api/gate",null,null);var t=new r.Deferred;return t.resolve(o.CryptoClient.settings.port.value),t}(t).then(function(r){o.CryptoClient.settings.port.value=r;var f=t+o.CryptoClient.settings.port.value+"/api"+n;s(e,f,i,u).then(function(e){c.resolve(e)},function(e){c.reject(e)})},function(r){o.CryptoClient.settings.port.value=o.CryptoClient.settings.defaultPort;var f=t+o.CryptoClient.settings.port.value+"/api"+n;s(e,f,i,u).then(function(e){c.resolve(e)},function(e){c.reject(e)})}),c},t.getOptions=function(e,t){var n={};return e=e||{},Object.keys(t).forEach(function(r){var o=e[r];n[r]=void 0===o?t[r]:o}),n};var i=/MSIE [89]/i.test(navigator.userAgent)?XDomainRequest:XMLHttpRequest}])});
//# sourceMappingURL=index.js.map